# Authentication and Authorization

The Tasktix project uses [Better-Auth](https://www.better-auth.com/) to provide authentication services for the application. BetterAuth was chosen over supabase or other alternatives because our database was setup as mysql, and additionaly migrating to postgres was deemed unnecessary. Better-Auth natively supports oauth and two factor which are left as future updates.   

>[!CAUTION]
> Pulling up a previous Tasktix version to adopt Better-Auth includes breaking database changes, and will result in loss of User Accounts. This can be manually remediated by peforming the steps in the Database Updates section.

Better Auth requires setting the following environment variables
```
.env/
BETTER_AUTH_SECRET=
BETTER_AUTH_URL=
```

The `BETTER_AUTH_SECRET` variable should be set to any random token of a minimum of 32 characters. It can be generated by running `openssl rand -base64 32`

The BETTER_AUTH_URL is the base URL of the application (e.g. http://localhost:3000)

## Client Side
The client side auth objects are defined in `@lib/auth-client.ts` and can be used by any front-end page by by importing the `AuthClient` object. Its methods function as wrappers of API requests to `/api/auth/[..]` endpoints, and it's responses can be handdled in `onError` and `onSuccess` callbacks.

For example, to sign a user in: 
```ts
const { data, error } = await authClient.signIn.email({
        /**
         * The user email
         */
        email,
        /**
         * The user password
         */
        password,
        /**
         * A URL to redirect to after the user verifies their email (optional)
         */
        callbackURL: "/dashboard",
        /**
         * remember the user session after the browser is closed. 
         * @default true
         */
        rememberMe: false
}, {
    //callbacks
})
```
To manage sessions from the client it should be prefered to use the `useAuth` hook which serves as a wrapper for BetterAuth to standardize session management across the app.

## Server Side
`authClient` methods should never be used from the server, instead use the `auth` object imported from `@lib/auth.ts`. These methods often call the same handler functions as the `authClient`, but allow us to use a custom API endpoint for more granular control, see `app/api/user/[id]/route.test.ts` for examples of this.

While it is possible to manually update Usernames, emails, etc. through handcrafted database writes, It should be preferred to use the Better-Auth wrapper (e.g. `auth.api.changeEmail()`). If a required operation is not supported by Better-Auth API, (e.g getting a user by email), it's custom implementation should be documented as such. 


## Database Updates

1) BEFORE PULLING UP: save a backup of your database
<!-- TODO: NATE document database update steps if worthwhile -->