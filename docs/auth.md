# Authentication and Authorization

The Tasktix project uses [Better-Auth](https://www.better-auth.com/) to provide authentication services for the application. Better-Auth was chosen over Supabase or other alternatives because our database was setup as MySQL, and additionaly migrating to Postgres was deemed unnecessary. Better-Auth natively supports OAuth and two factor which are left as future updates.   

> [!CAUTION]
>
> Pulling up a previous Tasktix version to adopt Better-Auth includes breaking database changes that require manual resolution. It also contains unavoidable password hashing changes and will result users losing the ability to sign in with their current account.

Better Auth requires setting the following environment variables
```
.env/
BETTER_AUTH_SECRET=
BETTER_AUTH_URL=
```

The `BETTER_AUTH_SECRET` variable should be set to any random token of a minimum of 32 characters. It can be generated by running `openssl rand -base64 32`

The BETTER_AUTH_URL is the base URL of the application (e.g. http://localhost:3000)

## Client Side
The client side auth objects are defined in `@lib/auth-client.ts` and can be used by any front-end page by by importing the `AuthClient` object. Its methods function as wrappers of API requests to `/api/auth/[..]` endpoints, and its responses can be handled in `onError` and `onSuccess` callbacks.

For example, to sign a user in: 
```ts
const { data, error } = await authClient.signIn.email({
        /**
         * The user email
         */
        email,
        /**
         * The user password
         */
        password,
        /**
         * A URL to redirect to after the user verifies their email (optional)
         */
        callbackURL: "/dashboard",
        /**
         * remember the user session after the browser is closed. 
         * @default true
         */
        rememberMe: false
}, {
    //callbacks
})
```
To manage sessions from the client it should be prefered to use the `useAuth` hook which serves as a wrapper for BetterAuth to standardize session management across the app.

## Server Side
`authClient` methods should never be used from the server, instead use the `auth` object imported from `@lib/auth.ts`. These methods often call the same handler functions as the `authClient`, but allow us to use a custom API endpoint for more granular control, see `app/api/user/[id]/route.test.ts` for examples of this.

While it is possible to manually update Usernames, emails, etc. through handcrafted database writes, It should be preferred to use the Better-Auth wrapper (e.g. `auth.api.changeEmail()`). If a required operation is not supported by Better-Auth API, (e.g getting a user by email), it's custom implementation should be documented as such. 


## Database Updates
The required schema for BetterAuth can be found [here](https://www.better-auth.com/docs/concepts/database#core-schema). To add login by username, it is required to extend that schema as described [here](https://www.better-auth.com/docs/plugins/username#schema). .

This results in the `User` table having the fields `name`, `username`, and `displayUsername`. Whenever creating an standard (non-OAuth) account, ensure you set `name` and username`, OAuth logins only provide the `name` field, and will have a null `username`. If an OAuth account wishes to go by a different name, it should be allowed to update the username field. For this reason, all accesses of username should be as follows:

```ts
const username = user.username ?? user.name;
```

`displayUsername` need never be considered/provided. Unless it is manually reconfigured, it will always be in sync with `username`. Additionally, Note that the `auth.api.isUsernameAvailable` only checks the `username` column. 
